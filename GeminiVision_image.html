<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2025/3/26 20:00
https://www.facebook.com/francefu

Try it
https://fustyles.github.io/webduino/GeminiVision_image.html
-->
<!DOCTYPE html>
<html>
<head>
	<title>Gemini Vision</title>
	<meta charset='utf-8'><meta http-equiv='Access-Control-Allow-Headers' content='Origin, X-Requested-With, Content-Type, Accept'>
	<meta http-equiv='Access-Control-Allow-Methods' content='GET,POST,PUT,DELETE,OPTIONS'>
	<meta http-equiv='Access-Control-Allow-Origin' content='*'><meta http-equiv='Access-Control-Allow-Credentials' content='true'>
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js'></script>
	<script src='https://fustyles.github.io/webduino/SpBlocklyJS/GameElements_20190131/marked.min.js'></script>
	<script src='https://fustyles.github.io/webduino/SpBlocklyJS/GameElements_20190131/gameelements.js'></script>
	<script src='https://fustyles.github.io/webduino/SpBlocklyJS/gemini_20240209/gemini.js'></script>
</head>
<body>
<div style="position:absolute;left:5px;top:0px">
Gemini API Key：<input type="text" id="apiKey" size="40" value=""><br><br>
<input type="file" id="selectImage"></input><br><br>
prompt (Vision)：<br>
<textarea id="prompt"  cols="65" rows="5">這是學生的作文，請轉錄文字，若無法辨識以空格替代。</textarea><br>
<input type="button" value="Run (Vision)" onclick="result.innerHTML = marked.parse('Please wait...');DetectImage();"><br>
<div id="result" style="color:blue;width:500px;height:150px;overflow:auto;border:1px solid #000;"></div><br>
prompt (Chat)：<br>
<textarea id="prompt1"  cols="65" rows="5">請批改上述作文，簡潔扼要。</textarea><br>
<input type="button" value="Run (Chat)" onclick="result1.innerHTML = marked.parse('Please wait...');chat();"><br>
<div id="result1" style="color:red;width:500px;height:150px;overflow:auto;border:1px solid #000;"></div>
</div>
<div style="position:absolute;left:510px;top:0px">
<img id="originImage">
</div>

<script>
var selectImage = document.getElementById('selectImage');
var originImage = document.getElementById('originImage'); 
var result = document.getElementById('result');
var apikey = document.getElementById("apiKey");
var prompt = document.getElementById("prompt");
var prompt1 = document.getElementById("prompt1");
var queryType = 1;
  
const delay = (seconds) => {
    return new Promise((resolve) => {
        setTimeout(resolve, seconds * 1000);
    });
};
const main = async () => {
    head_add_viewport(1, 1, 4, "yes");
    async function gemini_chat_response(gemini_chat_data) {
		console.log(gemini_chat_response_br(gemini_chat_data, 'n'));
		if (queryType)
			result.innerHTML = marked.parse(gemini_chat_response_br(gemini_chat_data, 'n')); 
		else
			result1.innerHTML = marked.parse(gemini_chat_response_br(gemini_chat_data, 'n'));		
    }
    window.gemini_chat_response = gemini_chat_response;
};
main();
  
async function DetectImage() {
	gemini_chat_initial(apikey.value, "gemini-2.0-flash", 1000, 1.0, 'You are a smart assistant.');
	queryType = 1;
	await gemini_chat_image_request(prompt.value+"\n\nPlease reply using markdown syntax!", imageToBase64());
}

async function chat() {
	gemini_chat_initial(apikey.value, "gemini-2.0-flash", 1000, 1.0, 'You are a smart assistant.');
	queryType = 0;
	await gemini_chat_run(result.innerText+"\n\n\n"+prompt1.value+"\n\n\nPlease reply using markdown syntax!");
}
    
selectImage.onchange = function (event) {
  var target = event.target || window.event.srcElement;
  var files = target.files;
  if (FileReader && files && files.length) {
    var fr = new FileReader();
    fr.onload = function () {
      result.innerHTML = "";
      originImage.src = fr.result;
    }
    fr.readAsDataURL(files[0]);
  }
}

function imageToBase64() {
    var canvas = document.createElement("canvas");
    canvas.width = originImage.naturalWidth;
    canvas.height = originImage.naturalHeight;
    var context = canvas.getContext("2d");
    context.drawImage(originImage, 0, 0);
    var base64 = canvas.toDataURL();
    var head = base64.substring(0, base64.indexOf(",") + 1);
    var data = base64.substring(base64.indexOf(",") + 1);
    data = encodeURIComponent(data);
    canvas = null;
    return (head + data);
}
</script>

</body>
</html>

<!-- Author: Fu Chung-Yi (Kaohsiung, Taiwan)   https://www.facebook.com/francefu      Update: 2018-12-31 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>myBlockly</title>
  <script>
	var script_blockly = [
		'https://blockly-demo.appspot.com/static/blockly_compressed.js',
		'https://blockly-demo.appspot.com/static/blocks_compressed.js',
		'https://blockly-demo.appspot.com/static/javascript_compressed.js',
		'https://fustyles.github.io/webduino/myBlockly/toolbox.js',

		'https://fustyles.github.io/webduino/myBlockly/example/Game_Tetris.js',
		'https://fustyles.github.io/webduino/myBlockly/example/Matrixled_Marquee_iloveyou.js',
		'https://fustyles.github.io/webduino/myBlockly/example/ShowText_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/Instruction_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/OpenURL_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/TaiwanAirQuality_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/MatrixLED_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/GameImage_example.js',
		'https://fustyles.github.io/webduino/myBlockly/example/GameCanvas_example.js',

		'https://fustyles.github.io/webduino/myBlockly/SetScreen/blocks_SetScreen.js',
		'https://fustyles.github.io/webduino/myBlockly/SetScreen/javascript_SetScreen.js',
		'https://fustyles.github.io/webduino/myBlockly/SetScreen/toolbox_SetScreen.js',

		'https://fustyles.github.io/webduino/myBlockly/ShowText/blocks_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/javascript_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/toolbox_ShowText.js',

		'https://fustyles.github.io/webduino/myBlockly/Keyboard/blocks_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/javascript_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/toolbox_Keyboard.js',
		
		'https://fustyles.github.io/webduino/myBlockly/Instruction/blocks_Instruction.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/javascript_Instruction.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/toolbox_Instruction.js',
		
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/blocks_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/javascript_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/toolbox_MatrixLed.js',
		
		'https://fustyles.github.io/webduino/myBlockly/GameElements/blocks_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/javascript_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/toolbox_GameAuxiliary.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/toolbox_GameTable.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/toolbox_GameCanvas.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/toolbox_GameImage.js',
		
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/blocks_OpenURL.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/javascript_OpenURL.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/toolbox_OpenURL.js',

		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/blocks_TaiwanAirQuality.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/javascript_TaiwanAirQuality.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/toolbox_TaiwanAirQuality.js',
		
		'https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js'
	];
	for (var i=0;i<script_blockly.length;i++) {
	  document.write("\<script src='"+script_blockly[i]+"'\>\<\/script>");
	}
	var language = location.search.toLowerCase();
	if (language.indexOf("lang=zh-hant")!=-1)
	{
		var script_msg = [
		'https://fustyles.github.io/webduino/myBlockly/zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/SetScreen/msg_SetScreen_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/msg_ShowText_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/msg_Keyboard_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/msg_Instruction_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/msg_MatrixLed_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/msg_GameElements_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/msg_OpenURL_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/msg_TaiwanAirQuality_zh-hant.js'
		];
	} 
	else if (language.indexOf("lang=zh-hans")!=-1) {
		var script_msg = [
		'https://fustyles.github.io/webduino/myBlockly/zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/SetScreen/msg_SetScreen_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/msg_ShowText_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/msg_Keyboard_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/msg_Instruction_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/msg_MatrixLed_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/msg_GameElements_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/msg_OpenURL_zh-hans.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/msg_TaiwanAirQuality_zh-hans.js'
		];
	} 
	else {
		var script_msg = [
		'https://fustyles.github.io/webduino/myBlockly/en.js',
		'https://fustyles.github.io/webduino/myBlockly/SetScreen/msg_SetScreen.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/msg_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/msg_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/msg_Instruction.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/msg_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/msg_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/msg_OpenURL.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/msg_TaiwanAirQuality.js'
		];
	}
	for (var i=0;i<script_msg.length;i++) {
	  document.write("\<script src='"+script_msg[i]+"'\>\<\/script>");
	}
	var script_iframe_run = [
		'https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/showtext.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/matrixled.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/gameelements.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/openurl.js',
		'https://fustyles.github.io/webduino/myBlockly/TaiwanAirQuality/taiwanairquality.js'
	];
  </script>
</head>
<body>

<table>
  <tr>
    <td align="left" valign="center">
      <div id="blocklyDiv" style="height: 620px; width: 900px;"></div>
    </td>
    <td align="left" valign="center">
      <input type="button" id="hide" value=">>" onclick="hideMySpace(this);">
    </td>
    <td align="left" valign="top">
      <table id="myfeatures">
        <tr>
          <td>
            <button onclick="document.getElementById('btnRun').disabled=true;runCode();">Run Screen</button>
            left<input type="text" id="ifrLeft" size="1" value="300" onfocus="this.select()">top<input type="text" id="ifrTop" size="1" value="20" onfocus="this.select()">width<input type="text" id="ifrWidth" size="1" value="600" onfocus="this.select()">height<input type="text" id="ifrHeight" size="1" value="600" onfocus="this.select()">
          </td>
        </tr>
        <tr>
          <td align="left" valign="center">
            <button onclick="exportCODE();">Export Javascript</button>
            <button onclick="exportHTML();">Export HTML</button>
            <button onclick="exportBlocks();">Backup Blocks(XML)</button>
          </td>
        </tr>
        <tr>
          <td align="left" valign="center">
            <button onclick="importBlocks()">Import Blocks</button><input id="myfile"  type="file" onchange ="getXML(this);" accept=".txt,.xml">
          </td>
        </tr>
        <tr>
          <td align="left" valign="center">
            <button onclick="demoWorkspace.clear();">Clear Workspace</button>
          </td>
        </tr>
        <tr>
          <td align="left" valign="center">
            Example
            <select onchange="if (this.value!='') XmldomToWorkspace(eval(this.value));this.value='';">
              <option value=""></option>
              <option value="Game_Tetris">Game_Tetris</option>
              <option value="Matrixled_Marquee_iloveyou">Matrixled_Marquee_iloveyou</option>
              <option value="ShowText_example">ShowText_example</option>
              <option value="Instruction_example">Instruction_example</option>
              <option value="OpenURL_example">OpenURL_example</option>
              <option value="TaiwanAirQuality_example">TaiwanAirQuality_example</option>
              <option value="GameImage_example">GameImage_example</option>
              <option value="GameCanvas_example">GameCanvas_example</option>
              <option value="MatrixLED_example">MatrixLED_example</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            Language
            <select onchange="var url=location.href.split('?')[0];location.href=url+'?lang='+this.value;">
              <option value=""></option>
              <option value="en">en</option>
              <option value="zh-Hant">zh-Hant</option>
              <option value="zh-Hans">zh-Hans</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>
            <textarea id="javscriptArea" cols="50" rows="28" readonly ondblclick="this.style.position='absolute';this.style.left='200px';this.style.top='100px';this.style.width='900px';" onfocusout="this.style.width='360px';this.style.position='static';"></textarea>
          </td>
        </tr>
        <tr>
          <td align="center">
            Fu Chung-Yi (Taiwan)  Update Date : 2018-12-31
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
	
<div id="runArea" style="left:250px;top:10px;position:absolute;display:none;z-index:9999">
  <button onclick="document.getElementById('btnRun').disabled=true;runCode();" id="btnRun">Run Code</button><button onclick="document.getElementById('btnRun').disabled=false;stopCode();">Stop Code</button><button onclick="closeScreen();">Close Screen</button>
  <br>
  <iframe id="iframe_run" style="width:600px;height:600px;background-color: white" frameborder="1"  scrolling="auto" allow="geolocation; microphone; camera"></iframe>
</div>

<xml id="toolbox" style="display: none"></xml>
<xml id="startBlocks" style="display: none"></xml>

<script>
//append category to toolbox
var category = [
	catSystem,
	"<sep></sep>",
	catSetScreen,
	catShowText,
	catKeyboard,
	catInstruction,
	catGameAuxiliary,
	catGameTable,
	catGameCanvas,
	catGameImage,
	catMatrixLed,
	catOpenURL,
	catTaiwanAirQuality
].join("");
while (category.toLowerCase().indexOf("<category")!=-1||category.toLowerCase().indexOf("<sep>")!=-1) {
  var s = category.toLowerCase().indexOf("<category");
  var s1 = category.toLowerCase().indexOf("<sep>");
  if (s1!=-1&&s1<s) {
    var e1 = category.toLowerCase().indexOf("</sep>");
    var xml = Blockly.Xml.textToDom("<xml>"+category.substring(s1,e1+6)+"</xml>");
    document.getElementById('toolbox').append(xml.firstChild);
    category=category.substr(e1+6);
  } else {
    var e = category.toLowerCase().indexOf("</category>");
    var xml = Blockly.Xml.textToDom("<xml>"+category.substring(s,e+11)+"</xml>");
    document.getElementById('toolbox').append(xml.firstChild);
    category=category.substr(e+11);
  }
}
	
var demoWorkspace = Blockly.inject('blocklyDiv',{media: 'https://blockly-demo.appspot.com/static/media/', toolbox: document.getElementById('toolbox'),zoom:{controls: true,wheel: true,startScale: 1.0,maxScale: 3,minScale: 0.3,scaleSpeed: 1.2},trashcan: true});
Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),demoWorkspace);

//append Game(Tetris) blocks to startBlocks
XmldomToWorkspace(Game_Tetris);
function XmldomToWorkspace(example) {	
  var xml = Blockly.Xml.textToDom(example);
  demoWorkspace.clear();
  Blockly.Xml.domToWorkspace(xml, demoWorkspace);
}

function showCode() {
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
  document.getElementById('javscriptArea').innerHTML = "//You can double click the textarea to enlarge.\n\n" + code;
}
demoWorkspace.addChangeListener(showCode);
	
function runCode() {
  window.LoopTrap = 1000;
  Blockly.JavaScript.INFINITE_LOOP_TRAP =
  'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
  var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
  var iframe_code="\<html\>\<head\>\<meta charset='utf-8'\>";
  for (var i=0;i<script_iframe_run.length;i++)  {
    iframe_code += "\<script src='"+script_iframe_run[i]+"'\>\<\/script>";
  }
  iframe_code += "\<\/head\>\<body\>\<div id='showText'\>\<\div>\<script\>const delay=(seconds)=>{return new Promise((resolve)=>{setTimeout(resolve,seconds*1000);});};const main=async()=>{"+code+"};main();\<\/script\>\<\/body\>\<\/html\>";
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  try {
    document.getElementById("runArea").style.left = document.getElementById("ifrLeft").value + "px";
    document.getElementById("runArea").style.top = document.getElementById("ifrTop").value + "px";
    document.getElementById("iframe_run").style.width = document.getElementById("ifrWidth").value + "px";
    document.getElementById("iframe_run").style.height = document.getElementById("ifrHeight").value + "px";
    document.getElementById("runArea").style.display = "block";
    document.getElementById("iframe_run").src = 'data:text/html;charset=utf-8,' + encodeURI(iframe_code);
    document.getElementById("iframe_run").focus();
  } catch (e) {
    alert(e);
  }
}
	
function stopCode() {
  try {	
    document.getElementById("iframe_run").src='data:text/html;charset=utf-8,';
  } catch (e) {
    alert(e);
  }
}
	
function closeScreen() {
  try {	
    document.getElementById("iframe_run").src='data:text/html;charset=utf-8,';	  
    document.getElementById("runArea").style.display = "none";
  } catch (e) {
    alert(e);
  }	  
}
	
function exportBlocks() {
  try {
    var xml = Blockly.Xml.workspaceToDom(demoWorkspace);
    var xml_text = Blockly.Xml.domToText(xml);
	  
    var link = document.createElement('a');
    link.download="project.txt";
    link.href="data:application/octet-stream;utf-8," + encodeURI(xml_text);
    document.body.appendChild(link);
    link.click();
    link.remove();
  } catch (e) {
    window.location.href="data:application/octet-stream;utf-8," + encodeURI(xml_text);
    alert(e);
  }
}

function exportHTML() {
  try {
    var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
    var iframe_code="\<html\>\<head\>\<meta charset='utf-8'\>";
    for (var i=0;i<script_iframe_run.length;i++)  {
      iframe_code += "\<script src='"+script_iframe_run[i]+"'\>\<\/script>";
    }
    iframe_code += "\<\/head\>\<body\>\<div id='showText'\>\<\div>\<script\>const delay=(seconds)=>{return new Promise((resolve)=>{setTimeout(resolve,seconds*1000);});};const main=async()=>{"+code+"};main();\<\/script\>\<\/body\>\<\/html\>";
    
    var link = document.createElement('a');
    link.download="project.html";
    link.href="data:application/octet-stream;utf-8," + encodeURI(iframe_code);
    document.body.appendChild(link);
    link.click();
    link.remove();
  } catch (e) {
    window.location.href="data:application/octet-stream;utf-8," + encodeURI(iframe_code);
    alert(e);
  }
}

function exportCODE() {
  try {
    var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
	  
    var link = document.createElement('a');
    link.download="code.txt";
    link.href="data:application/octet-stream;utf-8," + encodeURI(code);
    document.body.appendChild(link);
    link.click();
    link.remove();
  } catch (e) {
    window.location.href="data:application/octet-stream;utf-8," + encodeURI(code);
    alert(e);
  }
}
	
function importBlocks() {
  try {
    var xml_text = prompt("Please enter XML code", "");
    var xml = Blockly.Xml.textToDom(xml_text);
    demoWorkspace.clear();
    Blockly.Xml.domToWorkspace(xml, demoWorkspace);
  } catch (e) {
    alert(e);
  }
}

function hideMySpace(element) {
  if (document.getElementById('myfeatures').style.display != 'none') { 
    document.getElementById('myfeatures').style.display = 'none';
    element.value='<<';
    document.getElementById('blocklyDiv').style.width='1300px';
  } else {
    document.getElementById('myfeatures').style.display = 'block';
    element.value='>>';
    document.getElementById('blocklyDiv').style.width='900px';
  }
  Blockly.svgResize(demoWorkspace);
}

function getXML(element) {
  var file = element.files[0];
  var fr = new FileReader();           
  fr.onload = function (event) {
    var xml = Blockly.Xml.textToDom(event.target.result);
    demoWorkspace.clear();
    Blockly.Xml.domToWorkspace(xml, demoWorkspace);
  };
  fr.readAsText(file);
}
</script>

</body>
</html>

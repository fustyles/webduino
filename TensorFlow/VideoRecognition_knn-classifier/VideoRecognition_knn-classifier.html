<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2019/6/8
https://www.facebook.com/francefu
Try it!
https://fustyles.github.io/webduino/TensorFlow/VideoRecognition_knn-classifier/VideoRecognition_knn-classifier.html
-->

<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <!-- Load KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
 </head>

  <body>
  <video id="video" width="300" height="300" preload autoplay loop muted></video><br>
  <button onclick="saveModel();">Save Model</button><input type="file" id="getModel"></input><br>
  <button id="addExample">Train Example</button>
  <select id="Class"><option value="0" selected>0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select>
  <span id="count" style="font-size::18px;color:red">0</span>
  <div id="result" style="color:red">Please wait for loading model.</div>
  <canvas id="canvas" width="300" height="300" style="background-color:#000000;display:none;">
  <img id="example" width="300" height="300" style="display:none">
  </body>
  <script>
    
    navigator.mediaDevices
    .getUserMedia({
      audio: false,
      video: {
        facingMode: "user",
        width: 300,
        height: 300
      }
    })
    .then(stream => {
      video.srcObject = stream
      video.onloadedmetadata = () => {       
        video.play();
      }
    })
    
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext("2d"); 
    var addExample = document.getElementById('addExample');
    var example = document.getElementById('example');
    var Class = document.getElementById('Class');
    var result = document.getElementById('result');
    var count = document.getElementById('count');
    
    var state = false;
    var color = '#ffffff';
    var x0, y0;
    function canvas_mousedown(event) {
      state = state != true;
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    canvas.addEventListener("mousedown", canvas_mousedown, true);
    function canvas_mousemove(event) {
      if (state == true) {
        canvas_line('canvas',5,x0,y0,(mouse_coordinate_get("offsetX")),(mouse_coordinate_get("offsetY")),color,0,1);
      }
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    canvas.addEventListener("mousemove", canvas_mousemove, true); 
    
    function predictClass_onclick (event) {
      example.onload = function () {
        predictClass(example);
      }
      context.drawImage(video, 0, 0, video.width, video.height ,0 ,0 ,canvas.width, canvas.height);
      example.src = canvas.toDataURL('image/jpeg');
    };    
    
    function addExample_onclick (event) {
      context.drawImage(video, 0, 0, video.width, video.height ,0 ,0 ,canvas.width, canvas.height);
      example.src = canvas.toDataURL('image/jpeg');
      addExampleImage(example, Number(Class.value));
      count.innerHTML = Number(count.innerHTML)+1;
    };
    addExample.addEventListener("click", addExample_onclick, true);
    
  </script>
  
  <!-- Place your code in the script tag below. You can also use an external .js file -->
  <script>
    var classifier;
    var mobilenetModule;
    
    // Create the classifier.
    classifier = knnClassifier.create();
    
    // Load mobilenet.
    mobilenet.load().then(Module => {
      mobilenetModule = Module;
      setInterval(function(){ predictClass_onclick(); }, 200);
      result.innerHTML = '';
    }); 
    
    function addExampleImage(img,index) {
      // Add MobileNet activations to the model repeatedly for all classes.
      var Image = tf.browser.fromPixels(img);
      var logits = mobilenetModule.infer(Image, 'conv_preds');
      classifier.addExample(logits, index);
    }
    
    async function predictClass(img) {
      // Make a prediction.
      try
      {
        const Image = tf.browser.fromPixels(img);
        const xlogits = mobilenetModule.infer(Image, 'conv_preds');
        const predict = await classifier.predictClass(xlogits);
        //console.log(predict);
        var msg = "<font color='red'>Label : " + predict.label + "</font><br><br>";;
        for (i=0;i<Class.length;i++) {
          msg += "["+i+"] " + predict.confidences[i.toString()] + "<br>";
        }
        result.innerHTML = msg; 
      }
      catch (e)
      {
      }
    }

	function saveModel() {
	  let dataset = classifier.getClassifierDataset();
	  let myDataset = {}
	  Object.keys(dataset).forEach((key) => {
		let data = dataset[key].dataSync();
		myDataset[key] = Array.from(data);
	  });
	  let jsonStr = JSON.stringify(myDataset)
	  
	  var link = document.createElement('a');
	  link.download="model.json";
	  link.href='data:text/text;charset=utf-8,' + encodeURIComponent(jsonStr);
	  document.body.appendChild(link);
	  link.click();
	  link.remove();
	}

	document.getElementById('getModel').onchange = function (event) {
	  var target = event.target || window.event.srcElement;
	  var files = target.files;
	  var fr = new FileReader();
	  if (files.length>0) {
		fr.onload = function () {     
		  var dataset = fr.result;
		  var myDataset = JSON.parse(dataset)
		  Object.keys(myDataset).forEach((key) => {
			myDataset[key] = tf.tensor(myDataset[key], [myDataset[key].length / 1024, 1024]);
		  })
		  classifier.setClassifierDataset(myDataset);
		}
		fr.readAsText(files[0]);
	  }
	}
  </script>
</html>

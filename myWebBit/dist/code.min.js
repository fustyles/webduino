"use strict";var slice=Array.prototype.slice,baseUrl=baseUrl||".",storage=new JSONStorage("https://glowing-fire-4998.firebaseio.com/hyproto"),serializer=new window.XMLSerializer,parser=new window.DOMParser,validProjectId=/^[A-Za-z0-9]{10}$/,Code={LANGUAGE_NAME:{en:"English","zh-hant":"正體中文","zh-hans":"簡體中文"},LANGUAGE_RTL:["ar","fa","he"],workspace:null,getStringParamFromUrl:function(e,t){return Code.queryString=Code.queryString||new QueryString,Code.queryString.get(e)||t},getLang:function(){var e=Code.getStringParamFromUrl("lang","");return void 0===Code.LANGUAGE_NAME[e]&&(e="zh-hant"),e},getPage:function(){return Code.getStringParamFromUrl("page","index")},getCssClass:function(){return Code.getStringParamFromUrl("class","").trim()},getTags:function(){var e=Code.getStringParamFromUrl("tags","").trim();return console.log(e),e.length||(e="*"),e=e.split(/\s*,\s*/)},getDemoPage:function(){var e=Code.getStringParamFromUrl("demo","").trim();return e.length||(e="default"),e},getPinDropdown:function(){var e=Code.getTags(),t=[[["2","2"],["3~","3"],["4","4"],["5~","5"],["6~","6"],["7","7"],["8","8"],["9~","9"],["10~","10"],["11~","11"],["12","12"],["13","13"],["14 ( A0 )","14"],["15 ( A1 )","15"],["16 ( A2 )","16"],["17 ( A3 )","17"],["18 ( A4 )","18"],["19 ( A5 )","19"]],[["12~","12"],["13~","13"],["14~","14"],["15~","15"],["16~","16"],["AD","17"],["0~","0"],["TX","1"],["2~","2"],["RX","3"],["4~","4"],["5~","5"]],[["0","0"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["14","14"],["15","15"],["16","16"],["17","17"],["18","18"],["19","19"]],[["0~","0"],["1~ ( A4 )","1"],["2~ ( A5 )","2"],["3~","3"],["4~","4"],["5 ( A7 )","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10~","10"],["11","11"],["13","13"],["14","14"],["15","15"],["16","16"]]];return 1===e.length&&"*"!==e[0]?"smart"===e[0]?t[1]:t[0]:t[3]},loadDoc:function(e,t){var o=document.createElement("link"),n=document.getElementsByTagName("script")[0];if(o.rel="import",o.href=e,"function"!=typeof t)return new Promise(function(t){Code.loadDoc(e,t)});o.onload=function(){t(o.import)},n.parentNode.insertBefore(o,n)},loadJs:function(e,t,o){var n=document.createElement("script");document.getElementsByTagName("script")[0];if(n.async=1,n.src=e,"function"!=typeof t)return new Promise(function(t,o){Code.loadJs(e,t,o)});$.getScript(n.src).done(function(e,o){t(n)}).fail(function(e,l,a){"function"==typeof o&&o(n.src),t()})},isRtl:function(){return-1!=Code.LANGUAGE_RTL.indexOf(Code.LANG)},loadBlocks:function(e){try{var t=window.sessionStorage.loadOnceBlocks}catch(e){t=null}if(t){delete window.sessionStorage.loadOnceBlocks;var o=Blockly.Xml.textToDom(t);Blockly.Xml.domToWorkspace(o,Code.workspace)}else if(e){o=Blockly.Xml.textToDom(e);Blockly.Xml.domToWorkspace(o,Code.workspace)}else"BlocklyStorage"in window&&window.setTimeout(BlocklyStorage.restoreBlocks,0)},changeLanguage:function(){if("undefined"!=typeof Blockly&&window.sessionStorage){var e=Blockly.Xml.workspaceToDom(Code.workspace),t=Blockly.Xml.domToText(e);window.sessionStorage.loadOnceBlocks=t}var o=document.getElementById("languageMenu"),n=encodeURIComponent(o.options[o.selectedIndex].value),l="",a=window.location.host.replace(/:[0-9].*$/,"").split("."),r=a.slice(a.length-2,a.length).join(".");switch(n){case"zh-hant":l="zh-tw";break;case"zh-hans":l="zh-cn";break;case"en":default:l=n}Code.queryString.set("lang",n,!0),Cookies.set("locale",l,{domain:r})},bindClick:function(e,t){"string"==typeof e&&(e=document.getElementById(e)),e&&(e.addEventListener("click",t,!0),e.addEventListener("touchend",function(e){t.apply(this,arguments),e.preventDefault()},!0))},importPrettify:function(){var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",baseUrl+"/prettify-tomorrow.css"),e.onload=function(){Blockly.fireUiEvent(window,"resize")},document.head.appendChild(e),Code.loadJs(baseUrl+"/dist/lib/prettify.min.js")},getBBox_:function(e){var t=e.offsetHeight,o=e.offsetWidth,n=0,l=0;do{n+=e.offsetLeft,l+=e.offsetTop,e=e.offsetParent}while(e);return{height:t,width:o,x:n,y:l}},copyCode:function(e){(e={}).jsTab=document.getElementById("tab_javascript"),e.copyBtn=document.getElementById("copyCode"),e.clipboard=new Clipboard("#copyCode"),e.clipboard.on("success",function(t){e.copyBtn.setAttribute("data-tooltip","Copied!")}),e.copyBtn.addEventListener("mouseleave",function(){e.copyBtn.setAttribute("data-tooltip","Copy to clipboard")})},bindHotkey:function(e){Blockly.bindEvent_(e,"keydown",null,function(t){switch(Code.getHotKey(t)){case Code.HOTKEY.EXEC:Code.runJS();break;case Code.HOTKEY.SAVE:BlocklyStorage.unsaved=!0,BlocklyStorage.save(Code.workspace),BlocklySimStorage.save(e.getElementById("simulator-area"),e.getElementById("simulator-frame"))}})},getHotKey:function(e){if(e.ctrlKey||e.metaKey)switch(e.key){case"e":return Code.HOTKEY.EXEC;case"s":return e.preventDefault(),Code.HOTKEY.SAVE}return Code.HOTKEY.UNKNOWN},loadDemoArea:function(){var e,t,o=document.getElementById("demo-area"),n=document.querySelector(".demo-area-content"),l=document.getElementById("demoButton"),a=document.getElementById("demo-select"),r=document.querySelector(".close-btn"),i=Code.getDemoPage();o.className=o.className.replace("show",""),localStorage.demoArea&&(t=JSON.parse(localStorage.demoArea),Object.keys(t).forEach(function(e){t[e]&&(o.style[e]=t[e])})),o.className=o.className+"show",l.className="notext toolMenu opened",Code.queryString.set("demo",i),a.value="default",Code.reloadSandbox(),$(n).on("mousedown touchstart",function(e){e.stopPropagation()}),window.addEventListener("unload",function(){localStorage.demoArea=JSON.stringify({width:o.style.width,height:o.style.height,top:o.style.top,right:o.style.right})}),$(o).contents().click(function(){Code.setTopArea("demo")}),l.onclick=function(){clearTimeout(e);var t=Code.getDemoPage();"default"!==t?(o.className=o.className.replace("show",""),l.className="notext toolMenu",localStorage.demoAreaSelect=t,Code.queryString.unset("demo")):(o.className+=" show",l.className="notext toolMenu opened",Code.queryString.set("demo",localStorage.demoAreaSelect||"demo-area-01"),a.value=localStorage.demoAreaSelect||"demo-area-01",delete localStorage.demoAreaSelect,Code.setTopArea("demo")),Code.workspace.updateToolbox(Code.getToolBox()),e=setTimeout(function t(){Code.sandboxLoaded?Code.reloadSandbox():e=setTimeout(t)},300)},r.onclick=function(){o.className=o.className.replace("show",""),l.className="notext toolMenu",localStorage.demoAreaSelect=Code.getDemoPage(),Code.queryString.unset("demo"),Code.workspace.updateToolbox(Code.getToolBox())},a.onchange=function(){ga("send","event","Webduino-blockly","demo select",this.value),Code.queryString.set("demo",this.value),Code.workspace.updateToolbox(Code.getToolBox()),Code.reloadSandbox()}}};Code.loadSimulator=function(){var e=document.getElementById("simulator-area"),t=document.querySelector(".simulator-area-content"),o=document.getElementById("simulator-frame"),n=document.getElementById("simulatorButton"),l=document.querySelector("#simulator-area .close-btn"),a=document.querySelector("#simulator-area .icon-enlarge"),r=document.querySelector("#simulator-area .icon-shrink"),i=!1,c={};let s;window.localStorage[BlocklySimStorage.LOCALSTORAGE_KEY]&&(c=JSON.parse(window.localStorage[BlocklySimStorage.LOCALSTORAGE_KEY])),s=window.innerWidth<=1300?33:window.innerWidth>1300&&window.innerWidth<1600?97:171,c.config={name:"svg",width:370,height:365,zoom:{k:.7169776240079129,x:52.18736585040554,y:-9.139100003206224},data:{components:[{type:"WebduinoBit",id:"id_WebduinoBit",x:s,y:36}],paths:[]}},window.localStorage.setItem(BlocklySimStorage.LOCALSTORAGE_KEY,JSON.stringify(c)),m();o.contentWindow.innerWidth;function d(){if(e.classList.contains("full"))return e.style.height="",void(e.style.top="");e.style.height=e.dataset.height||""}function u(){if(e.classList.contains("full"))return e.style.width="",void(e.style.right="");e.style.width=e.dataset.width||""}function m(){"BlocklySimStorage"in window&&BlocklySimStorage.restoreBlocks(e,o,n)}o.contentWindow.blockly.setPosition("#id_WebduinoBit",1,1),"BlocklySimStorage"in window&&BlocklySimStorage.backupOnUnload(e,o),setTimeout(function(){e.classList.remove("init")},1e3),Code.simulator={start:function(){var e=function(){var e=[];return Blockly.Xml.workspaceToDom(Code.workspace).querySelectorAll('block[type="board"],block[type="board_ready"]').forEach(function(t){var o;console.log(t),o=t.querySelector('[name="device_"]')?t.querySelector('[name="device_"]').textContent:"Webduino Bit",console.log(o);var n="bit"===t.querySelector('[name="type_"]').textContent,l="true"===localStorage.getItem("simulatorWifi");(n||l)&&e.push({id:o,local:n,boardType:"bit"})}),e}();e.length&&(o.contentWindow.blockly.setDevice(e),o.contentWindow.blockly.start())},stop:function(){o.contentWindow.blockly.stop()},update:function(e){window.localStorage.setItem(BlocklySimStorage.LOCALSTORAGE_KEY,JSON.stringify(e)),m()}},Code.bindClick(n,function(){e.classList.toggle("show"),n.classList.toggle("opened"),Code.setTopArea("simulator")}),Code.bindClick("linkButton",function(){var t=Blockly.Xml.workspaceToDom(Code.workspace),n=Blockly.Xml.domToText(t),l=BlocklySimStorage.getConfig_(e,o),a=localStorage.getItem("customBlocks")||"",r=axios.CancelToken.source();i&&r.cancel("Operation canceled by the user."),i=!0,axios.post("/api/projects/link",{xml:n,simulator:l,customBlocks:a},{cancelToken:r.token}).then(function(e){var t=e.data.hashid,o=e.data.isLogin,n=new Date(e.data.expirationDate).toLocaleDateString(),l=location.origin+"/blockly/#"+t,a=o?MSG.shareLink:MSG.shareLinkTrial.replace("%1",n);if(!t)return Promise.reject(new Error("No hashid!"));location.hash=t,swal({icon:"info",title:a,content:{element:"a",attributes:{href:l,text:l,target:"_blank"}}}),i=!1}).catch(function(e){axios.isCancel(e)||swal({icon:"error",text:MSG.errorOccur})})}),Code.bindClick(l,function(){e.classList.remove("show","full"),n.classList.remove("opened"),u(),d()}),Code.bindClick(a,function(){e.classList.add("full"),u(),d()}),Code.bindClick(r,function(){e.classList.remove("full"),u(),d()}),$(e).contents().click(function(){Code.setTopArea("simulator")}),$(o).load(function(){$(o).contents().click(function(){Code.setTopArea("simulator")})}),$(t).on("mousedown touchstart",function(e){e.stopPropagation()})},Code.setTopArea=function(e){$.each({demo:"demo-area",simulator:"simulator-area",help:"help-area"},function(t,o){var n=$("#"+o);n.removeClass("topFrame"),e===t&&n.addClass("topFrame")})},Code.LANG=Code.getLang(),Code.PAGE=Code.getPage(),Code.running=!1,Code.sandboxLoaded=!0,Code.lastRun=0,Code.HOTKEY={EXEC:0,SAVE:1,UNKNOWN:-1},Code.rawToolbox=null,Code.loadedData=null,Code.TABS_=["blocks","javascript","custom"],Code.selected="blocks",Code.tabClick=function(e){if(!("custom"!==e||Code.user_&&Code.user_.email))return swal({icon:"info",title:MSG.otherFunctions,text:MSG.loginToUseCustomBlock,buttons:[MSG.cancel,MSG.loginPlatform]}).then(function(e){e&&window.open("https://id.webduino.io")}),!1;if(Code.TABS_.xml&&"tabon"==document.getElementById("tab_xml").className){var t=document.getElementById("content_xml").value,o=null;try{o=Blockly.Xml.textToDom(t)}catch(e){if(!window.confirm(MSG.badXml.replace("%1",e)))return}o&&(Code.workspace.clear(),Blockly.Xml.domToWorkspace(o,Code.workspace))}for(var n=0;n<Code.TABS_.length;n++){var l=Code.TABS_[n];document.getElementById("tab_"+l).className="taboff",document.getElementById("content_"+l).style.visibility="hidden"}switch(Code.selected=e,document.getElementById("tab_"+e).className="tabon",document.getElementById("content_"+e).style.visibility="visible",Code.renderContent(),e){case"blocks":Code.customTab.close(e),Code.workspace.setVisible(!0),$("#copyCode").hide();break;case"javascript":Code.customTab.close(e),Code.workspace.setVisible(!1),$("#copyCode").css("display","table-cell");break;case"custom":Code.customTab.isOpen()?Code.customTab.close():($("#copyCode").hide(),Code.workspace.setVisible(!1),Code.customTab.open())}Blockly.fireUiEvent(window,"resize")},Code.loadGa=function(e){var t=function(){(window.ga.q=window.ga.q||[]).push(arguments)};t.l=Date.now(),window.GoogleAnalyticsObject="ga",window.ga=t,t("create","UA-62202920-13","auto"),t("send","pageview"),Code.loadJs("https://www.google-analytics.com/analytics.js")},Code.ga=function(e,t,o){for(e=document.querySelector(".blocklySvg"),t=document.querySelectorAll(".toolMenu"),e.addEventListener("mouseup",function(){ga("send","event","Webduino-blockly","editing")}),o=0;o<t.length;o++)t[o].addEventListener("click",function(){var e=this.getAttribute("id");ga("send","event","Webduino-blockly","menu click",e)})},Code.editFilename=function(){$("#blocklyHeader .filename").on("click",function(e){var t="",o=window.location.hash.substring(1),n=(validProjectId.test(o)?"[hashid]=":"[id]=")+o;swal({text:MSG.codeJsChangeFileName,content:{element:"input",attributes:{defaultValue:$("#blocklyHeader .filename").text()}}}).then(function(e){return!!e&&(t=e,new Promise(function(e,t){$.getJSON("/api/users/"+Token.getUserId()+"/projects?filter[where]"+n+"&access_token="+Token.getId(),function(t){e(t)})}))}).then(function(e){return!!e&&(e=e[0],new Promise(function(o,n){$.ajax({url:"/api/users/"+Token.getUserId()+"/projects/"+e.id+"?access_token="+Token.getId(),method:"PUT",data:{name:t},success:function(e){o(e)},error:function(e,t,o){n(o)}})}))}).then(function(e){var o=document.title.split(" - ")[1];e&&(document.title=t+" - "+o,$("#blocklyHeader .filename").text(t),swal.close())}).catch(function(e){const t="object"==typeof e?e.toString():e;swal("Error",t,"error"),swal.stopLoading(),swal.close()})})},Code.renderContent=function(){var e=document.getElementById("content_"+Code.selected);switch(e.id){case"content_javascript":var t=Blockly.JavaScript.workspaceToCode(Code.workspace);t=js_beautify(t,{indent_size:"2",space_in_empty_paren:!0}),e.textContent=t,"function"==typeof prettyPrintOne&&(t=e.innerHTML,t=prettyPrintOne(t,"js"),e.innerHTML=t);break;case"content_custom":break;case"content_xml":default:var o=document.getElementById("content_xml"),n=Blockly.Xml.workspaceToDom(Code.workspace),l=Blockly.Xml.domToPrettyText(n);o.value=l,o.focus()}},Code.filterXML=function(e,t,o){function n(e){var n=e.getAttribute(t).trim().split(/\s*,\s*/);(n=n.filter(function(e){return-1!==o.indexOf("*")||-1!==o.indexOf(e)})).length||Code.pruneNode(e)}return e=document.importNode(e,!0),slice.call(e.querySelectorAll("category")).forEach(function(e){null!==e.getAttribute(t)&&n(e)}),slice.call(e.querySelectorAll("block")).forEach(function(e){null!==e.getAttribute(t)&&n(e)}),e},Code.pruneNode=function(e){if(e&&e.parentElement){var t=e.parentElement;t.removeChild(e),t.children.length||Code.pruneNode(t)}},Code.getToolBox=function(){for(var e,t=Code.filterXML(Code.filterXML(Code.rawToolbox,"tags",Code.getTags()),"demo",[Code.getDemoPage()]),o=slice.call(t.querySelectorAll("category")).map(function(e){return e.id}),n=0;e=o[n];n++)t.querySelector("#"+e).setAttribute("name",MSG[e]);return t},Code.addToolbox=function(e,t){var o=Code.rawToolbox.querySelector("category[id="+e+"]")||Code.rawToolbox,n=t.id&&o.querySelector("#"+t.id);if(n)n.parentNode.replaceChild(t,n);else if(t.hasAttribute("index")){var l=[],a=parseInt(t.getAttribute("index")),r=[].slice.apply(o.children);if(!(r=r.filter(function(e){return"category"===e.tagName.toLowerCase()&&!e.hasAttribute("demo")})).length)return void o.appendChild(t);r.forEach(function(e){e.hasAttribute("index")?l.push(parseInt(e.getAttribute("index"))):l.push(0)});for(var i=l.length-1;i>=0;i--)if(a>=l[i]){r[i].parentNode.insertBefore(t,r[i].nextSibling);break}}else o.insertBefore(t,o.children[0])},Code.removeToolbox=function(e,t){var o=Code.rawToolbox.querySelector("category[id="+e+"]")||Code.rawToolbox;t.id&&$(o).find("#"+t.id).length>0&&$(o).find("#"+t.id).remove()},Code.getUrlParts=function(){return(location.protocol+"//"+location.host+location.pathname).split("/")},Code.init=function(e){Code.initLanguage();var t,o=Code.isRtl(),n=document.getElementById("mainTable"),l=function(e){for(var o=Code.getBBox_(n),l=0;l<Code.TABS_.length;l++){var a=document.getElementById("content_"+Code.TABS_[l]);a.style.top=o.y+"px",a.style.left=o.x+"px",a.style.height=o.height+"px",a.style.width=o.width+"px"}Code.workspace.toolbox_.width&&(t=document.querySelector(".blocklyTreeRow.blocklyTreeSelected"),document.getElementById("tab_blocks").style.minWidth=t?t.offsetWidth-38+"px":Code.workspace.toolbox_.width-38+"px");let r,i=function(e,t){if(e.fireEvent)e.fireEvent("on"+t);else{var o=document.createEvent("Events");o.initEvent(t,!0,!1),e.dispatchEvent(o)}};clearTimeout(r),e&&e.isTrusted&&(document.getElementById("simulator-frame").contentWindow.blockly.setScale(.72),window.innerWidth<=1300?document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",76,17):window.innerWidth>1300&&window.innerWidth<1600?document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",122,17):document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",175,17),r=setTimeout(()=>{document.querySelector(".blocklySvg").offsetWidth!=document.querySelector("#content_blocks").offsetWidth&&(i(document.querySelector(".blocklyMainBackground"),"mousedown"),i(document.querySelector(".blocklyMainBackground"),"mouseup"))},1e3))};window.addEventListener("resize",l,!1),Code.workspace=Blockly.inject("content_blocks",{grid:{spacing:25,length:3,colour:"#ddd",snap:!0},media:baseUrl+"/components/blockly-src/media/",rtl:o,toolbox:e,zoom:{controls:!0,wheel:!1,startScale:1}}),Blockly.WorkspaceSvg.prototype.zoomReset=function(e){this.scale=1,this.updateGridPattern_(),Blockly.hideChaff(!1),this.flyout_&&this.flyout_.reflow(),this.scrollbar&&this.scrollbar.resize();var t=this.getMetrics();this.scrollbar?this.scrollbar.set((t.contentWidth-t.viewWidth)/2,(t.contentHeight-t.viewHeight)/2):this.translate(0,0),e.stopPropagation()},Blockly.JavaScript.addReservedWords("code,timeouts,checkTimeout"),Code.loadBlocks(Code.loadedData&&Code.loadedData.xml),"BlocklyStorage"in window&&BlocklyStorage.backupOnUnload(Code.workspace),Code.tabClick(Code.selected),document.getElementById("simulator-reset").onclick=function(){document.getElementById("simulator-frame").contentWindow.blockly.setScale(.72),window.innerWidth<=1300?document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",76,17):window.innerWidth>1300&&window.innerWidth<1600?document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",122,17):document.getElementById("simulator-frame").contentWindow.blockly.setPosition("#id_WebduinoBit",175,17)},Code.eduExport(),Code.eduImport(),Code.rightAreaToggle(),Code.rightAreaResize(),Code.bindClick("qrButton",function(){var e=Code.getContext(),t=document.querySelector("#openModal");return t.classList.add("show"),$(t).find(".close").one("click",function(){return t.classList.remove("show"),!1}),launcher.loadTemplate("./templates/"+e.tpl+".html",function(t){t.body=launcher.translate(t.body,MSG),t.head=launcher.injectDependencies(t.head,e.deps),"babel"===e.jsPreprocessor?t.js=Code.transform(e.data.js):t.js=e.data.js,launcher.liveview(storage,t,function(e){var t=document.querySelector("#qrImg"),o=document.querySelector("#qrLink");t.src="http://chart.apis.google.com/chart?cht=qr&chl="+window.encodeURIComponent(e)+"&chs=300x300",o.setAttribute("href",e)})}),!1}),Code.bindClick("linkToBin",function(){var e=Code.getContext(),t=Code.getUrlParts();t.pop(),localStorage.setItem(t.join("/")+"/launcher.html",JSON.stringify(e))}),Code.bindClick("trashButton",function(){Code.discard(),Code.renderContent()}),Code.bindClick("runButton",Code.runJS),Code.workspace.addChangeListener(function(e){"ui"!==e.type&&(BlocklyStorage.unsaved=!0,clearTimeout(Code.saveTime),Code.saveTime=setTimeout(function(){BlocklyStorage.save(Code.workspace),BlocklySimStorage.save(document.getElementById("simulator-area"),document.getElementById("simulator-frame"))},1e3),BlocklyStorage.monitorChanges_(Code.workspace))});for(var a=0;a<Code.TABS_.length;a++){var r=Code.TABS_[a];Code.bindClick("tab_"+r,function(e){return function(){Code.tabClick(e)}}(r))}var i=document.querySelectorAll(".filterBtn");"smart"==Code.getTags()[0]&&(i[0].className="filterBtn",i[1].className="filterBtn selected"),i.forEach(function(e,t){i[t].onclick=function(){i.forEach(function(e,t){i[t].className="filterBtn"}),i[t].className="filterBtn selected";var e=this.getAttribute("tag");e?Code.queryString.set("tags",e):Code.queryString.unset("tags"),Code.workspace.updateToolbox(Code.getToolBox()),setTimeout(function(){Blockly.fireUiEvent(window,"resize")},50)}}),l(),Code.editFilename()},Code.initHandlebars=function(){Handlebars.registerHelper("if_eq",function(e,t,o){return e==t?o.fn(this):o.inverse(this)})},Code.renderPage=function(e){var t=document.head,o=document.body,n=Handlebars.compile(e);o.innerHTML=n(MSG),slice.call(o.querySelectorAll("script")).forEach(function(e){var n=document.createElement("script");e.getAttribute("src")?(n.setAttribute("src",e.getAttribute("src")),t.appendChild(n),o.removeChild(e)):e.text&&(n.text=e.text,t.appendChild(n),o.removeChild(e))})},Code.initLanguage=function(){var e=Code.isRtl();document.dir=e?"rtl":"ltr",document.head.parentElement.setAttribute("lang",Code.LANG);var t=[];for(var o in Code.LANGUAGE_NAME)t.push([Code.LANGUAGE_NAME[o],o]);t.sort(function(e,t){return e[0]>t[0]?1:e[0]<t[0]?-1:0});var n=document.getElementById("languageMenu");n.options.length=0;for(var l=0;l<t.length;l++){var a=t[l],r=(o=a[a.length-1],new Option(a[0],o));o==Code.LANG&&(r.selected=!0),n.options.add(r)}n.addEventListener("change",Code.changeLanguage,!0),document.title=" "+MSG.documentTitle},Code.runJS=function(){if(Code.sandboxLoaded){!function(){var e=Date.now();if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)){if(e-Code.lastRun<1e3)return;Code.lastRun=e}Code.running?Code.simulator.stop():Code.simulator.start(),Code.toggleRunning(),Code.reloadSandbox()}()}},Code.reloadSandbox=function(){var e=Code.getContext();function t(e){var t=document.querySelector(".demo-area-content"),o=document.createElement("iframe");return o.id="demo-frame",o.style.display="block",t.appendChild(o),Code.tabClick("blocks"),o.addEventListener("load",function(){Code.sandboxLoaded=!0}),launcher.sandbox(o,e),Code.bindHotkey(o.contentWindow.document),Code.running&&Code.hookEvents(window,o),o}Code.sandboxLoaded=!1,launcher.loadTemplate("./templates/"+e.tpl+".html",function(o){o.body=launcher.translate(o.body,MSG),Code.running&&(o.head=launcher.injectDependencies(o.head,e.deps),"babel"===e.jsPreprocessor?o.js=Code.transform(e.data.js):o.js=e.data.js);var n=document.querySelector("#demo-frame");n?(n.contentWindow.$(n.contentWindow).triggerHandler("destroy"),n.contentWindow.addEventListener("unload",function(){t(o)},!1),setTimeout(function(){var e=new UIEvent("beforeunload");n.contentWindow.dispatchEvent(e)}),setTimeout(function(){!function(e){var t=document.querySelector(".demo-area-content");Code.unhookEvents(window,e),t.removeChild(e)}(n)},500)):t(o)})},Code.hookEvents=function(e,t){e.keyDispatcher=function(e){if(Code.getHotKey(e)!==Code.HOTKEY.EXEC&&Code.getHotKey(e)!==Code.HOTKEY.SAVE){var o=t.contentWindow.document,n=o.createEvent("Event");n.initEvent(e.type,!0,!0),n.key=e.key,n.keyCode=e.keyCode,o.body&&o.body.dispatchEvent(n)}},e.msgDispatcher=function(o){var n=o.data;n.jsonrpc&&n.result&&t.contentWindow.postMessage(n,e.location.origin)},t.msgDispatcher=function(t){var o=t.data;o.jsonrpc&&o.method&&e.postMessage(o,e.location.origin)},e.addEventListener("keydown",e.keyDispatcher,!1),e.addEventListener("keyup",e.keyDispatcher,!1),e.addEventListener("message",e.msgDispatcher,!1),t.contentWindow.addEventListener("message",t.msgDispatcher,!1)},Code.unhookEvents=function(e,t){t.msgDispatcher&&(t.contentWindow.removeEventListener("message",t.msgDispatcher,!1),delete t.msgDispatcher),e.msgDispatcher&&(e.removeEventListener("message",e.msgDispatcher,!1),delete e.msgDispatcher),e.keyDispatcher&&(e.removeEventListener("keyup",e.keyDispatcher,!1),e.removeEventListener("keydown",e.keyDispatcher,!1),delete e.keyDispatcher)},Code.getContext=function(){var e=Blockly.JavaScript.workspaceToCode(Code.workspace),t=Code.getBlocksDependencies(Code.getBlockTypes()),o=-1!==e.indexOf("async function"),n=Code.PAGE,l=Code.LANG;return{page:n,tpl:"index"===n?Code.getDemoPage():n,lang:l,modes:"html,css,js,output",deps:t,data:{js:e},jsPreprocessor:o?"babel":""}},Code.transform=function(e){try{return Babel.transform(e,{presets:["es2015","stage-3"],plugins:["transform-strict-mode"]}).code}catch(e){alert(e)}},Code.discard=function(){var e=Code.workspace.getAllBlocks().length;(e<2||window.confirm(Blockly.Msg.DELETE_ALL_BLOCKS.replace("%1",e)))&&Code.workspace.clear()},Code.debug=function(){for(var e="",t=0;t<Blockly.JavaScript.depth;t++)e+="  ";console.log.apply(console,[e].concat(Array.prototype.slice.apply(arguments)))},Code.exportImage=function(){Code.workspace.zoomReset(document.createEvent("MouseEvents")),saveSvgAsPng(Code.workspace.getCanvas(),"webduino-blocks.png")},Code.getBlockDemo=function(e){var t,o=Code.rawToolbox.querySelector("block[type="+e+"]");if(o)for(;o=o.parentNode;)if(1===o.nodeType&&"category"===o.tagName.toLowerCase()&&(t=o.getAttribute("demo")))return t;return null},Code.getBlockTypes=function(){var e=Blockly.Xml.workspaceToDom(Code.workspace);return slice.call(e.querySelectorAll("block")).map(function(e){return e.getAttribute("type")})},Code.trimXml=function(e){var t=serializer.serializeToString(e);return t=t.replace(/>\s*/g,">").replace(/\s*</g,"<"),parser.parseFromString(t,"text/xml").firstChild},Code.updateTitle=function(e){},Code.setUser=function(e){Code.user_=e},Blockly.JavaScript.procedures_defnoreturn=function(e){var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=Blockly.JavaScript.statementToCode(e,"STACK");Blockly.JavaScript.STATEMENT_PREFIX&&(o=Blockly.JavaScript.prefixLines(Blockly.JavaScript.STATEMENT_PREFIX.replace(/%1/g,"'"+e.id+"'"),Blockly.JavaScript.INDENT)+o),Blockly.JavaScript.INFINITE_LOOP_TRAP&&(o=Blockly.JavaScript.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+e.id+"'")+o);var n=Blockly.JavaScript.valueToCode(e,"RETURN",Blockly.JavaScript.ORDER_NONE)||"";n&&(n="  return "+n+";\n");for(var l=[],a=0;a<e.arguments_.length;a++)l[a]=Blockly.JavaScript.variableDB_.getName(e.arguments_[a],Blockly.Variables.NAME_TYPE);var r="function "+t+"("+l.join(", ")+") {\n"+o+n+"}";return-1!==(r=Blockly.JavaScript.scrub_(e,r)).indexOf("await ")&&(r="async "+r),Blockly.JavaScript.definitions_[t]=r,null},Blockly.JavaScript._procedures_callreturn=Blockly.JavaScript.procedures_callreturn,Blockly.JavaScript.procedures_callreturn=function(e){var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=Blockly.JavaScript._procedures_callreturn.call(Blockly.JavaScript,e),n=Blockly.JavaScript.definitions_;return n[t]&&0===n[t].indexOf("async ")?["await "+o[0],o[1]]:o},Blockly.JavaScript._procedures_callnoreturn=Blockly.JavaScript.procedures_callnoreturn,Blockly.JavaScript.procedures_callnoreturn=function(e){var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=Blockly.JavaScript._procedures_callnoreturn.call(Blockly.JavaScript,e),n=Blockly.JavaScript.definitions_;return n[t]&&0===n[t].indexOf("async ")?"await "+o:o},Blockly.JavaScript._workspaceToCode=Blockly.JavaScript.workspaceToCode,Blockly.JavaScript.workspaceToCode=function(e){var t=Blockly.JavaScript._workspaceToCode.call(Blockly.JavaScript,e);return t=-1===t.indexOf("await ")?t.replace(new RegExp("async function","g"),"function"):"(async function () {\n\n"+t+"\n}());"},Blockly.Xml._domToWorkspace=Blockly.Xml.domToWorkspace,Blockly.Xml.domToWorkspace=function(){Blockly.Xml._domToWorkspace.apply(this,arguments);for(var e=Code.getBlockTypes(),t=0;t<e.length;t++){var o=Code.getBlockDemo(e[t]);if(o)return void(o!==Code.queryString.get("demo")&&(Code.queryString.set("demo",o),Code.loadDemoArea(),Code.workspace.updateToolbox(Code.getToolBox())))}},Blockly.JavaScript.scrub_=function(e,t){if(!e.outputConnection||!e.outputConnection.targetConnection)for(var o=0;o<e.inputList.length;o++)if(e.inputList[o].type==Blockly.INPUT_VALUE)e.inputList[o].connection.targetBlock();var n=e.nextConnection&&e.nextConnection.targetBlock();return""+t+Blockly.JavaScript.blockToCode(n)},Blockly.WorkspaceSvg.prototype.showContextMenu_=function(e){if(!this.options.readOnly&&!this.isFlyout){var t=[],o=this.getTopBlocks(!0),n=Blockly.genUid(),l={};l.text=Blockly.Msg.UNDO,l.enabled=this.undoStack_.length>0,l.callback=this.undo.bind(this,!1),t.push(l);var a={};if(a.text=Blockly.Msg.REDO,a.enabled=this.redoStack_.length>0,a.callback=this.undo.bind(this,!0),t.push(a),this.scrollbar){var r={};r.text=MSG.cleanUpBlocks,r.enabled=o.length>1,r.callback=this.cleanUp_.bind(this),t.push(r)}l.text=MSG.UNDO,a.text=MSG.REDO;var i={};i.text=MSG.exportImage,i.enabled=o.length>0,i.callback=Code.exportImage.bind(Code),t.push(i);var c=10;if(this.options.collapse){for(var s=!1,d=!1,u=0;u<o.length;u++)for(var m=o[u];m;)m.isCollapsed()?s=!0:d=!0,m=m.getNextBlock();var p=function(e){for(var t=0,n=0;n<o.length;n++)for(var l=o[n];l;)setTimeout(l.setCollapsed.bind(l,e),t),l=l.getNextBlock(),t+=c},g={enabled:d};g.text=Blockly.Msg.COLLAPSE_ALL,g.callback=function(){p(!0)},t.push(g);var y={enabled:s};y.text=Blockly.Msg.EXPAND_ALL,y.callback=function(){p(!1)},t.push(y)}var f=[];for(u=0;u<o.length;u++)k(o[u]);var h={text:1==f.length?Blockly.Msg.DELETE_BLOCK:Blockly.Msg.DELETE_X_BLOCKS.replace("%1",String(f.length)),enabled:f.length>0,callback:function(){(f.length<2||window.confirm(Blockly.Msg.DELETE_ALL_BLOCKS.replace("%1",String(f.length))))&&C()}};t.push(h),Blockly.ContextMenu.show(e,t,this.RTL)}function k(e){if(e.isDeletable())f=f.concat(e.getDescendants());else for(var t=e.getChildren(),o=0;o<t.length;o++)k(t[o])}function C(){Blockly.Events.setGroup(n);var e=f.shift();e&&(e.workspace?(e.dispose(!1,!0),setTimeout(C,c)):C()),Blockly.Events.setGroup(!1)}},Blockly.WorkspaceSvg.prototype.preloadAudio_=function(){},Blockly.BlockSvg.prototype.showContextMenu_=function(e){if(!this.workspace.options.readOnly&&this.contextMenu){var t=this,o=[];if(this.isDeletable()&&this.isMovable()&&!t.isInFlyout){var n={text:Blockly.Msg.DUPLICATE_BLOCK,enabled:!0,callback:function(){Blockly.duplicate_(t)}};if(this.getDescendants().length>this.workspace.remainingCapacity()&&(n.enabled=!1),o.push(n),this.isEditable()&&!this.collapsed_&&this.workspace.options.comments){var l={enabled:!goog.userAgent.IE};this.comment?(l.text=Blockly.Msg.REMOVE_COMMENT,l.callback=function(){t.setCommentText(null)}):(l.text=Blockly.Msg.ADD_COMMENT,l.callback=function(){t.setCommentText("")}),o.push(l)}if(!this.collapsed_)for(var a=1;a<this.inputList.length;a++)if(this.inputList[a-1].type!=Blockly.NEXT_STATEMENT&&this.inputList[a].type!=Blockly.NEXT_STATEMENT){var r={enabled:!0},i=this.getInputsInline();r.text=i?Blockly.Msg.EXTERNAL_INPUTS:Blockly.Msg.INLINE_INPUTS,r.callback=function(){t.setInputsInline(!i)},o.push(r);break}if(this.workspace.options.collapse)if(this.collapsed_){var c={enabled:!0};c.text=Blockly.Msg.EXPAND_BLOCK,c.callback=function(){t.setCollapsed(!1)},o.push(c)}else{var s={enabled:!0};s.text=Blockly.Msg.COLLAPSE_BLOCK,s.callback=function(){t.setCollapsed(!0)},o.push(s)}if(this.workspace.options.disable){var d={text:this.disabled?Blockly.Msg.ENABLE_BLOCK:Blockly.Msg.DISABLE_BLOCK,enabled:!this.getInheritedDisabled(),callback:function(){t.setDisabled(!t.disabled)}};o.push(d)}var u=this.getDescendants().length,m=this.getNextBlock();m&&(u-=m.getDescendants().length);var p={text:1==u?Blockly.Msg.DELETE_BLOCK:Blockly.Msg.DELETE_X_BLOCKS.replace("%1",String(u)),enabled:!0,callback:function(){Blockly.Events.setGroup(!0),t.dispose(!0,!0),Blockly.Events.setGroup(!1)}};o.push(p)}var g={enabled:!!(goog.isFunction(this.helpUrl)?this.helpUrl():this.helpUrl)};g.text=Blockly.Msg.HELP,g.callback=function(){t.showHelp_()},o.push(g);var y={};y.text=Blockly.Msg.TOOL,this.toolUrl?y.enabled=!0:y.enabled=!1,y.callback=function(){t.showTool_()},o.push(y),this.customContextMenu&&!t.isInFlyout&&this.customContextMenu(o),Blockly.ContextMenu.show(e,o,this.RTL),Blockly.ContextMenu.currentBlock=this}},Blockly.Block.prototype.setToolUrl=function(e){this.toolUrl=e},Blockly.BlockSvg.prototype.showTool_=function(){var e=goog.isFunction(this.toolUrl)?this.helpUrl():this.toolUrl;e&&window.open(e)},Blockly.detectUSB=function(e){let t="";e&&(t=e.device||"(unknow)"),ga("send","event","USB","pageview",t)},Blockly.Block.prototype.jsonInit=function(e){goog.asserts.assert(void 0==e.output||void 0==e.previousStatement,"Must not have both an output and a previousStatement."),void 0!==e.colour&&this.setColour(e.colour);for(var t=0;void 0!==e["message"+t];)this.interpolate_(e["message"+t],e["args"+t]||[],e["lastDummyAlign"+t]),t++;void 0!==e.inputsInline&&this.setInputsInline(e.inputsInline),void 0!==e.output&&this.setOutput(!0,e.output),void 0!==e.previousStatement&&this.setPreviousStatement(!0,e.previousStatement),void 0!==e.nextStatement&&this.setNextStatement(!0,e.nextStatement),void 0!==e.tooltip&&this.setTooltip(e.tooltip),void 0!==e.helpUrl&&this.setHelpUrl(e.helpUrl),void 0!==e.toolUrl&&this.setToolUrl(e.toolUrl)},goog.provide("Blockly.Variables"),goog.require("Blockly.Workspace"),goog.require("goog.string"),Blockly.Variables.NAME_TYPE="VARIABLE",Blockly.Variables.allVariables=function(e){var t;if(e.getDescendants)t=e.getDescendants();else{if(!e.getAllBlocks)throw"Not Block or Workspace: "+e;t=e.getAllBlocks()}for(var o=Object.create(null),n=0;n<t.length;n++)for(var l=t[n].getVars(),a=0;a<l.length;a++){var r=l[a];r&&(o[r.toLowerCase()]=r)}var i=[];for(var c in o)i.push(o[c]);return i},Blockly.Variables.renameVariable=function(e,t,o){Blockly.Events.setGroup(!0);for(var n=o.getAllBlocks(),l=0;l<n.length;l++)n[l].renameVar(e,t);Blockly.Events.setGroup(!1)},Blockly.Variables.flyoutCategory=function(e){var t=Blockly.Variables.allVariables(e);t.sort(goog.string.caseInsensitiveCompare),goog.array.remove(t,Blockly.Msg.VARIABLES_DEFAULT_NAME),t.unshift(Blockly.Msg.VARIABLES_DEFAULT_NAME);var o=[];if(Blockly.Blocks.variables_set){let e=goog.dom.createDom("block");e.setAttribute("type","variables_set"),e.setAttribute("gap",20),o.push(e)}if(Blockly.Blocks.variables_change){let e=goog.dom.createDom("block");e.setAttribute("type","variables_change"),e.setAttribute("gap",20),o.push(e)}for(let e=0;e<t.length;e++)if(Blockly.Blocks.variables_get){let n=goog.dom.createDom("block");n.setAttribute("type","variables_get"),n.setAttribute("gap",20);let l=goog.dom.createDom("field",null,t[e]);l.setAttribute("name","VAR"),n.appendChild(l),o.push(n)}return o},Blockly.Variables.generateUniqueName=function(e){var t=Blockly.Variables.allVariables(e),o="";if(t.length)for(var n=1,l="ijkmnopqrstuvwxyzabcdefgh",a=0,r=l.charAt(a);!o;){for(var i=!1,c=0;c<t.length;c++)if(t[c].toLowerCase()==r){i=!0;break}i?(++a==l.length&&(a=0,n++),r=l.charAt(a),n>1&&(r+=n)):o=r}else o="i";return o},Blockly.JavaScript.depth=0,document.write('<script src="'+baseUrl+"/msg/"+Code.LANG+'.js"><\/script>\n'),document.write('<script src="'+baseUrl+"/components/blockly-src/msg/js/"+Code.LANG+'.js"><\/script>\n'),document.write('<script src="'+baseUrl+"/blocks/msg/"+Code.LANG+'.js"><\/script>\n'),document.write('<script src="'+baseUrl+"/msg/notification/"+Code.LANG+'.js"><\/script>\n'),"index"!==Code.PAGE&&(document.write('<script src="'+baseUrl+"/msg/"+Code.PAGE+"/"+Code.LANG+'.js"><\/script>\n'),document.write('<script src="'+baseUrl+"/blocks/"+Code.PAGE.split("/")[0]+'.js"><\/script>\n'),document.write('<script src="'+baseUrl+"/generators/"+Code.PAGE.split("/")[0]+'.js"><\/script>\n'));